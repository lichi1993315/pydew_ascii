# 猫咪照护系统设计文档

## 1. 系统概述

### 1.1 设计目标
- 为玩家提供有意义的宠物照护体验
- 增强玩家与猫咪的情感联系
- 提供长期养成目标和挑战
- 丰富游戏的经济系统

### 1.2 核心机制
- **心情值系统**：影响猫咪行为和效率
- **精力值系统**：控制猫咪的活动和休息
- **猫窝系统**：提供专属休息场所
- **照护责任**：需要玩家主动关怀

## 2. 心情值系统设计

### 2.1 基础参数
- **数值范围**：0-100
- **初始值**：50
- **更新频率**：每秒检查一次

### 2.2 心情下降机制
| 条件 | 下降速度 | 触发条件 |
|------|----------|----------|
| 无猫窝 | -2/分钟 | 猫咪无专属猫窝 |
| 精力过低 | -1/分钟 | 精力值 < 30 |
| 缺乏互动 | -1/5分钟 | 5分钟内未与玩家互动 |

### 2.3 心情提升机制
| 活动 | 提升数值 | 触发条件 |
|------|----------|----------|
| 猫咪间对话 | +5 | 参与猫咪对话 |
| 成功抓虫 | +3 | 每次成功抓到昆虫 |
| 与玩家聊天 | +8 | 每次与玩家对话 |
| 猫窝睡觉 | +2/分钟 | 在自己的猫窝睡觉 |
| 猫咪聚集事件 | +10 | 参与特殊猫咪事件 |
| 睡眠奖励 | +5 | 每次睡眠结束 |

### 2.4 心情等级效果
| 心情范围 | 状态 | 效果 |
|----------|------|------|
| 80-100 | 😸 开心 | 抓虫效率+20% |
| 60-79 | 😊 正常 | 无特殊效果 |
| 40-59 | 😐 一般 | 抓虫效率-10% |
| 20-39 | 😿 沮丧 | 抓虫效率-20%，移动速度-10% |
| 0-19 | 😭 极度沮丧 | 5分钟后离开警告 |
| 0 | 💔 心碎 | 立即离开游戏世界 |

## 3. 精力值系统设计

### 3.1 基础参数
- **数值范围**：0-100
- **初始值**：100
- **更新频率**：每秒检查一次

### 3.2 精力消耗机制
| 活动 | 消耗速度 | 备注 |
|------|----------|------|
| 正常活动 | -1/分钟 | 基础消耗 |
| 移动状态 | -2/分钟 | 移动时额外消耗 |
| 抓虫活动 | -5/次 | 每次抓虫尝试 |
| 对话活动 | -2/次 | 每次对话参与 |

### 3.3 精力恢复机制
| 状态 | 恢复速度 | 备注 |
|------|----------|------|
| 地面睡觉 | +10/分钟 | 在地面睡觉 |
| 猫窝睡觉 | +20/分钟 | 在自己的猫窝睡觉 |
| 闲置状态 | +1/分钟 | 静止不动时 |

### 3.4 精力阈值
- **睡眠触发**：精力值 ≤ 30
- **睡眠结束**：精力值 ≥ 80
- **疲劳状态**：精力值 < 50时移动速度-20%

## 4. 猫窝系统设计

### 4.1 猫窝类型
| 类型 | 价格 | 精力恢复 | 心情奖励 | 外观 |
|------|------|----------|----------|------|
| 简易猫窝 | 100金币 | +15/分钟 | +1/分钟 | 🛏️ |
| 舒适猫窝 | 200金币 | +20/分钟 | +2/分钟 | 🏠 |
| 豪华猫窝 | 400金币 | +25/分钟 | +3/分钟 | 🏰 |

### 4.2 所有权机制
- **一猫一窝**：每只猫咪只能拥有一个猫窝
- **专属使用**：猫咪只能使用自己的猫窝
- **名称显示**：猫窝显示主人猫咪的名字
- **绑定机制**：购买时自动绑定到指定猫咪

### 4.3 购买流程
1. 在商店选择猫窝类型
2. 选择要绑定的猫咪（从拥有的猫咪中选择）
3. 支付金币完成购买
4. 猫窝进入玩家背包

### 4.4 放置逻辑
1. 按B键打开背包界面
2. 选择要放置的猫窝
3. 进入放置模式
4. 显示可放置区域（高亮显示）
5. 点击确认放置位置
6. 猫窝固定在地图上

### 4.5 放置限制
- ❌ 不能放置在水域
- ❌ 不能放置在建筑物上
- ❌ 不能放置在其他交互物品上
- ❌ 不能与其他猫窝重叠
- ✅ 可以放置在草地、泥土等地面上

## 5. 睡眠机制设计

### 5.1 睡眠触发条件
- **自动触发**：精力值 ≤ 30
- **寻找顺序**：自己的猫窝 → 空旷地面

### 5.2 睡眠状态
- **状态标识**：头顶显示 💤 表情
- **动画效果**：猫咪保持静止状态
- **活动停止**：停止所有移动和互动

### 5.3 睡眠地点选择
```
优先级排序：
1. 自己的猫窝（如果存在且可达）
2. 玩家附近的空旷地面
3. 当前位置（如果无法找到更好位置）
```

### 5.4 睡眠结束条件
- **精力恢复**：精力值 ≥ 80
- **心情奖励**：+5心情值
- **状态重置**：恢复正常活动状态

## 6. 背包系统扩展

### 6.1 背包分类
```python
class Player:
    def __init__(self):
        self.item_inventory = {}      # 原有物品
        self.seed_inventory = {}      # 原有种子
        self.cat_bed_inventory = {}   # 新增：猫窝背包
        self.placement_mode = None    # 新增：放置模式
```

### 6.2 猫窝背包结构
```python
cat_bed_inventory = {
    "simple_bed": [
        {"bed_id": "bed_001", "owner_cat": "橘猫咪", "owner_id": "cat_橘猫咪"},
        {"bed_id": "bed_002", "owner_cat": "小白", "owner_id": "cat_小白"}
    ],
    "comfort_bed": [
        {"bed_id": "bed_003", "owner_cat": "小黑", "owner_id": "cat_小黑"}
    ]
}
```

### 6.3 背包UI设计
- **分页显示**：物品、种子、猫窝分页
- **猫窝详情**：显示主人、类型、效果
- **放置按钮**：选择猫窝后显示放置选项

## 7. 商店系统扩展

### 7.1 商品配置
```python
# 在settings.py中添加
PURCHASE_PRICES = {
    'corn': 4,
    'tomato': 5,
    'simple_cat_bed': 100,    # 简易猫窝
    'comfort_cat_bed': 200,   # 舒适猫窝
    'luxury_cat_bed': 400,    # 豪华猫窝
}

CAT_BED_TYPES = {
    'simple_cat_bed': {
        'name': '简易猫窝',
        'energy_restoration': 15,
        'mood_bonus': 1,
        'ascii_char': '🛏️'
    },
    'comfort_cat_bed': {
        'name': '舒适猫窝',
        'energy_restoration': 20,
        'mood_bonus': 2,
        'ascii_char': '🏠'
    },
    'luxury_cat_bed': {
        'name': '豪华猫窝',
        'energy_restoration': 25,
        'mood_bonus': 3,
        'ascii_char': '🏰'
    }
}
```

### 7.2 购买流程
1. 商店显示猫窝商品
2. 选择猫窝类型
3. 弹出猫咪选择界面
4. 选择要绑定的猫咪
5. 确认购买和支付

## 8. UI系统改进

### 8.1 猫咪详情界面
- **心情值进度条**：显示当前心情值和状态
- **精力值进度条**：显示当前精力值
- **猫窝信息**：显示是否拥有猫窝
- **状态说明**：显示当前状态和效果

### 8.2 状态通知系统
- **心情低警告**：心情值 < 30时显示
- **需要睡眠**：精力值 < 30时显示
- **离开警告**：心情值 = 0时显示倒计时
- **猫窝需求**：无猫窝时定期提醒

### 8.3 放置模式UI
- **区域高亮**：显示可放置的区域
- **禁止标识**：显示不可放置的区域
- **确认按钮**：确认放置位置
- **取消按钮**：取消放置模式

## 9. 技术实现细节

### 9.1 数据结构
```python
class CatNPC(ASCIINPC):
    def __init__(self, ...):
        # 新增属性
        self.mood_value = 50              # 心情值
        self.energy_value = 100           # 精力值
        self.sleep_state = "awake"        # 睡眠状态
        self.owned_cat_bed = None         # 拥有的猫窝
        self.last_interaction_time = 0    # 最后互动时间
        self.mood_decay_timer = 0         # 心情衰减计时器
        self.energy_decay_timer = 0       # 精力衰减计时器
        self.sleep_location = None        # 睡眠位置
        self.leaving_warning_timer = 0    # 离开警告计时器
```

### 9.2 更新机制
```python
def update_cat_status(self, dt):
    # 更新计时器
    self.mood_decay_timer += dt
    self.energy_decay_timer += dt
    
    # 心情值衰减
    if self.mood_decay_timer >= 60:  # 每分钟检查
        self.update_mood_decay()
        self.mood_decay_timer = 0
    
    # 精力值更新
    if self.energy_decay_timer >= 60:  # 每分钟检查
        self.update_energy_status()
        self.energy_decay_timer = 0
    
    # 睡眠状态检查
    self.check_sleep_state()
    
    # 离开机制检查
    self.check_leaving_condition()
```

## 10. 数值平衡

### 10.1 时间设计
- **游戏内一天**：约20分钟现实时间
- **心情衰减周期**：无猫窝时约50分钟降至0
- **精力消耗周期**：正常活动约100分钟耗尽
- **睡眠恢复时间**：猫窝睡眠约5分钟恢复满

### 10.2 经济平衡
- **简易猫窝**：相当于卖10条鱼的收入
- **舒适猫窝**：相当于卖13条鱼的收入
- **豪华猫窝**：相当于卖27条鱼的收入

### 10.3 体验平衡
- **照护压力**：不会过于频繁打扰玩家
- **成就感**：购买猫窝后有明显效果提升
- **长期目标**：为每只猫咪购买合适的猫窝

## 11. 实现优先级

### 11.1 第一阶段（核心系统）
1. 扩展CatNPC类添加心情值和精力值
2. 实现基础的数值更新机制
3. 创建CatBed类
4. 实现睡眠状态基本逻辑

### 11.2 第二阶段（商店与背包）
1. 扩展商店系统支持猫窝购买
2. 实现背包系统猫窝存储
3. 实现B键背包界面
4. 实现放置模式

### 11.3 第三阶段（互动与离开）
1. 更新各种互动的心情值奖励
2. 实现猫咪离开机制
3. 完善睡眠地点选择逻辑
4. 优化数值平衡

### 11.4 第四阶段（UI与优化）
1. 更新猫咪详情UI
2. 添加状态通知系统
3. 优化用户体验
4. 最终测试和调优

## 12. 预期效果

### 12.1 玩家体验
- **责任感**：需要关注猫咪的状态
- **成就感**：通过照护提升猫咪幸福度
- **投资感**：购买猫窝的经济投入
- **情感联系**：与猫咪建立更深的情感纽带

### 12.2 游戏深度
- **长期目标**：为每只猫咪配备合适的猫窝
- **策略选择**：不同类型猫窝的效果差异
- **资源管理**：平衡金币在不同用途的分配
- **养成乐趣**：观察和改善猫咪的生活质量

这个系统将显著提升游戏的宠物养成体验，为玩家提供更有意义的照护责任和情感联系。